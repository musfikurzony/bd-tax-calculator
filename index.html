<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ডাইনামিক আয়কর ক্যালকুলেটর (Dynamic Income Tax Calculator)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Bengali:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Bengali', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            font-size: 1.1rem;
        }
        .section-header {
            border-left: 5px solid #10b981;
        }
        .accordion-button {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content rounded-xl p-6">
            <h2 id="settingsModalTitle" class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">সেটিংস ও কনফিগারেশন (Settings & Configuration) <button onclick="closeModal()" class="text-gray-500 hover:text-gray-900 text-3xl font-light">&times;</button></h2>
            
            <p id="settingsWarning" class="text-sm text-red-600 mb-4 bg-red-50 p-3 rounded-lg">
                **সতর্কতা (Warning):** এই মানগুলি পরিবর্তন করে **Save** করলে, এই ব্রাউজারে অ্যাপটি খোলার সময় সবসময় নতুন মানগুলিই লোড হবে।
            </p>

            <h3 id="settingsExemptionTitle" class="text-lg font-semibold text-teal-700 mb-2">করমুক্ত সীমা (Tax Exemption Limits)</h3>
            <div id="exemptionSettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white mb-6">
                <!-- Exemption fields rendered here -->
            </div>

            <h3 id="settingsMinTaxTitle" class="text-lg font-semibold text-teal-700 mb-2">ন্যূনতম কর (Minimum Tax Values)</h3>
            <div id="locationSettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white mb-6">
                <!-- Location fields rendered here -->
            </div>

            <h3 id="settingsSDCapTitle" class="text-lg font-semibold text-teal-700 mb-2">সর্বজনীন ছাড়ের সীমা (Standard Deduction Cap)</h3>
            <div id="standardDeductionSettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white mb-6">
                 <div class="flex space-x-2">
                    <input type="text" id="sdCapLabel" value="Standard Deduction ক্যাপ (Maximum)" readonly class="p-2 border rounded w-1/2 text-sm bg-gray-100 font-medium text-gray-700">
                    <input type="number" id="sdCapValue" value="500000" class="p-2 border rounded w-1/2 text-sm" placeholder="মান (Tk.)">
                </div>
            </div>

            <h3 id="settingsSlabTitle" class="text-lg font-semibold text-teal-700 mb-2">আয়কর স্ল্যাব হার ও সীমা (Tax Slab Settings)</h3>
            <div id="taxSlabSettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white mb-6">
                 <div id="slabHeader" class="flex space-x-2 font-bold text-sm text-gray-700 pb-1 border-b">
                    <span class="w-1/3">স্ল্যাব বিবরণ (Description)</span>
                    <span class="w-1/3">সীমা (Limit Tk.)</span>
                    <span class="w-1/3">হার (Rate %)</span>
                </div>
                <!-- Tax Slab fields rendered here -->
            </div>
            
            <div class="flex justify-end space-x-4">
                <button onclick="saveSettings()" id="saveSettingsBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    সেভ ও বন্ধ করুন (Save & Close)
                </button>
            </div>
        </div>
    </div>
    <!-- End Settings Modal -->

    <div class="max-w-4xl mx-auto card bg-white rounded-xl overflow-hidden">
        <header class="bg-teal-600 p-6 flex justify-between items-start">
            <div>
                <!-- Header Change: Split into two lines for better visual balance -->
                <h1 id="appTitle" class="text-2xl sm:text-3xl font-bold text-white mb-0 leading-tight">ডাইনামিক আয়কর ক্যালকুলেটর</h1>
                <h1 id="appSubTitleEn" class="text-xl sm:text-2xl font-bold text-white mb-1 leading-tight">(Dynamic Income Tax Calculator)</h1>
                <p id="appInfo" class="text-sm text-teal-200">Standard Deduction পদ্ধতি</p>
            </div>
            <div class="flex space-x-3 items-center">
                <!-- Language Dropdown -->
                <select id="languageSelect" onchange="switchLanguage(this.value)" class="text-sm rounded-md bg-teal-500 text-white p-1.5 border border-teal-300">
                    <option value="BN">বাংলা</option>
                    <option value="EN">English</option>
                </select>
                <!-- Settings Button -->
                <button onclick="openModal()" id="settingsBtn" class="text-white hover:text-teal-200 transition duration-150">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m10.5-6h-9.75m9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="p-4 sm:p-6">

            <!-- A. Input Section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h2 id="inputSectionTitle" class="section-header text-xl font-semibold text-gray-800 mb-4 pl-3">১. ইনপুট ভেরিয়েবল (Input Variables)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Tax Exemption Limit DROPDOWN -->
                    <div class="col-span-full md:col-span-1">
                        <label id="taxExemptionLabel" for="taxExemptionSelect" class="block text-sm font-medium text-gray-700">করমুক্ত সীমা (Taxpayer Exemption)</label>
                        <select id="taxExemptionSelect" onchange="calculateTax();" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border text-base">
                             <!-- Options populated by JS -->
                        </select>
                    </div>

                    <!-- Location for Minimum Tax DROPDOWN -->
                    <div class="col-span-full md:col-span-1">
                        <label id="locationLabel" for="locationSelect" class="block text-sm font-medium text-gray-700">অবস্থান (Minimum Tax Location)</label>
                        <select id="locationSelect" onchange="calculateTax();" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border text-base">
                             <!-- Options populated by JS -->
                        </select>
                    </div>
                    
                    <!-- EMPTY SPACER/ALIGNMENT -->
                    <div class="col-span-full md:col-span-1"></div>


                    <!-- Monthly Gross Salary -->
                    <div class="col-span-full md:col-span-1">
                        <label id="salaryLabel" for="monthlyGrossSalary" class="block text-sm font-medium text-gray-700">মাসিক গ্রস বেতন (Monthly Gross Salary - Tk.)</label>
                        <input type="number" id="monthlyGrossSalary" value="200000" oninput="calculateTax()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border">
                        <p id="salaryNote" class="text-xs text-gray-500 mt-1">এখানে বেসিক ও সকল মাসিক ভাতা অন্তর্ভুক্ত (Basic + All Allowances).</p>
                    </div>

                    <!-- Employer's PF Contribution Rate -->
                    <div class="col-span-full md:col-span-1">
                        <label id="pfRateLabel" for="pfRate" class="block text-sm font-medium text-gray-700">PF কন্ট্রিবিউশন রেট (%) (PF Contribution Rate)</label>
                        <input type="number" id="pfRate" value="5" oninput="calculateTax()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border">
                    </div> 

                    <!-- 13th Month Bonus -->
                    <div class="col-span-full md:col-span-1 flex items-center pt-2">
                        <input type="checkbox" id="is13thMonth" checked onchange="calculateTax()" class="h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label id="bonusCheckLabel" for="is13thMonth" class="ml-2 block text-sm font-medium text-gray-700">১৩ তম মাস / উৎসব বোনাস যুক্ত করুন (Include 13th Month/Festival Bonus)</label>
                    </div>

                    <!-- Other Bonus Amount -->
                    <div class="col-span-full md:col-span-1">
                        <label id="otherBonusLabel" for="otherBonus" class="block text-sm font-medium text-gray-700">অন্যান্য বোনাস (মোট বার্ষিক Tk.) (Other Annual Bonus)</label>
                        <input type="number" id="otherBonus" value="0" oninput="calculateTax()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border">
                    </div>
                    
                    <!-- New: Employee PF Contribution (Now Read-only) -->
                    <div class="col-span-full md:col-span-2">
                        <label id="employeePFLabel" for="employeePFContribution" class="block text-sm font-medium text-gray-700">কর্মচারীর (আপনার) বার্ষিক PF অবদান (Employee's Annual PF Contribution - Tk.)</label>
                        <input type="number" id="employeePFContribution" value="0" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border bg-gray-100">
                        <p id="employeePFNote" class="text-xs text-gray-500 mt-1">এই পরিমাণটি এমপ্লয়ারের কন্ট্রিবিউশনের সমান এবং স্বয়ংক্রিয়ভাবে গণনা করা হয় (Equal to Employer's Contribution, Auto-calculated).</p>
                    </div>

                     <!-- Investment Amount -->
                    <div class="col-span-full md:col-span-2">
                        <label id="investmentLabel" for="otherAnnualInvestment" class="block text-sm font-medium text-gray-700">অন্যান্য বার্ষিক বিনিয়োগ (DPS, শেয়ার, ইত্যাদি Tk.) (Other Annual Investment)</label>
                        <input type="number" id="otherAnnualInvestment" value="0" oninput="calculateTax()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2.5 border">
                    </div>

                </div>
            </div>

            <!-- B. Final Results Summary (Always visible) -->
            <div class="mb-6 p-4 bg-teal-600 rounded-lg text-white card">
                <h2 id="finalTaxTitle" class="text-2xl font-bold mb-2">৬. চূড়ান্ত প্রদেয় আয়কর (Net Tax Payable)</h2>
                <div class="flex justify-between items-center border-b border-teal-300 pb-2 mb-2">
                    <span id="finalTaxPayableLabel" class="text-sm font-medium">মোট বার্ষিক প্রদেয় আয়কর (Total Annual Tax Payable)</span>
                    <span id="finalTaxPayable" class="text-3xl font-extrabold">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span id="monthlyTaxDeductionLabel" class="text-sm font-medium">মাসিক আনুমানিক কর কর্তন (Estimated Monthly Deduction)</span>
                    <span id="monthlyTaxDeduction" class="text-xl font-bold">0</span>
                </div>
            </div>
            
             <!-- C. Investment Summary (New Section) -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <div id="investmentSummaryHeader" class="accordion-button bg-blue-500 hover:bg-blue-600 p-4 rounded-t-lg flex justify-between items-center text-white" onclick="toggleSection('investmentSummarySection')">
                    <h2 class="text-lg font-semibold">৩.১ বিনিয়োগের সারসংক্ষেপ (Investment Summary - Incl. PF)</h2>
                    <span id="investmentSummaryIcon" class="text-xl transform transition-transform duration-300">+</span>
                </div>
                <div id="investmentSummarySection" class="p-4 bg-blue-50 hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                <tr>
                                    <td id="employeePFContributionRow" class="px-6 py-2 text-left">কর্মচারীর (আপনার) বার্ষিক PF অবদান (Employee's Annual PF Contribution)</td>
                                    <td id="employeePFDisplay" class="px-6 py-2 text-right font-medium text-teal-600">0</td>
                                </tr>
                                <tr>
                                    <td id="employerPFContributionRow" class="px-6 py-2 text-left">এমপ্লয়ারের বার্ষিক PF অবদান (Employer's Annual PF Contribution)</td>
                                    <td id="employerPFDisplay" class="px-6 py-2 text-right font-medium text-teal-600">0</td>
                                </tr>
                                <tr class="bg-blue-100">
                                    <td id="totalAutoInvestmentRow" class="px-6 py-2 text-left font-bold">মোট স্বয়ংক্রিয় PF বিনিয়োগ (Total Automatic PF Investment - Employee's Share Only)</td>
                                    <td id="totalAutoInvestmentDisplay" class="px-6 py-2 text-right font-extrabold text-blue-700">0</td>
                                </tr>
                                <tr>
                                    <td id="extraInvestmentNeededRow" class="px-6 py-2 text-left font-bold text-red-600">সর্বোচ্চ অতিরিক্ত বিনিয়োগের প্রয়োজন (Max Top-up Investment Needed)</td>
                                    <td id="extraInvestmentNeeded" class="px-6 py-2 text-right font-extrabold text-red-600">0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- D. Tax Rebate Calculation Details (Collapsible) -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <div id="rebateHeader" class="accordion-button bg-yellow-500 hover:bg-yellow-600 p-4 rounded-t-lg flex justify-between items-center text-white" onclick="toggleSection('rebateSection')">
                    <h2 class="text-lg font-semibold">৪. কর রেয়াত গণনা (Tax Rebate Calculation)</h2>
                    <span id="rebateIcon" class="text-xl transform transition-transform duration-300">+</span>
                </div>
                <div id="rebateSection" class="p-4 bg-yellow-50 hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                <tr>
                                    <td id="eligibleInvestmentLimitRow" class="px-6 py-2 text-left">সর্বোচ্চ যোগ্য বিনিয়োগ সীমা (Max Eligible Investment Limit - 20% of Taxable Income)</td>
                                    <td id="eligibleInvestmentLimitDisplay" class="px-6 py-2 text-right font-medium text-teal-600">0</td>
                                </tr>
                                <tr>
                                    <td id="totalActualInvestmentRow" class="px-6 py-2 text-left">মোট প্রকৃত বিনিয়োগ (Total Actual Investment - PF + Other)</td>
                                    <td id="totalActualInvestmentDisplay" class="px-6 py-2 text-right font-medium text-teal-600">0</td>
                                </tr>
                                <tr>
                                    <td id="grossTaxLiabilityRow" class="px-6 py-2 text-left">গ্রস ট্যাক্স লায়াবিলিটি (Gross Tax Liability - Before Rebate)</td>
                                    <td id="grossTaxLiability" class="px-6 py-2 text-right font-medium">0</td>
                                </tr>
                                <tr>
                                    <td id="taxRebateAmountRow" class="px-6 py-2 text-left font-bold">চূড়ান্ত কর রেয়াত (Final Tax Rebate - 15%)</td>
                                    <td id="taxRebateAmount" class="px-6 py-2 text-right text-red-600 font-extrabold">0</td>
                                </tr>
                                <tr>
                                    <td id="minimumTaxRow" class="px-6 py-2 text-left">ন্যূনতম প্রদেয় কর (Minimum Tax)</td>
                                    <td id="minimumTaxValue" class="px-6 py-2 text-right font-medium">0</td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-yellow-100 border-t-2 border-yellow-200 font-semibold">
                                <tr>
                                    <td id="netTaxPayableRow" class="px-6 py-3 text-left">Net Tax Payable (Gross Tax - Rebate)</td>
                                    <td id="netTaxPayable" class="px-6 py-3 text-right text-teal-700">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- E. Summary and Exemption Table (Collapsible) -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <div id="summaryHeader" class="accordion-button bg-gray-100 hover:bg-gray-200 p-4 rounded-t-lg flex justify-between items-center" onclick="toggleSection('summarySection')">
                    <h2 class="text-lg font-semibold text-gray-800">২. চূড়ান্ত করযোগ্য আয় (Final Taxable Income - After Standard Deduction)</h2>
                    <span id="summaryIcon" class="text-xl transform transition-transform duration-300">+</span>
                </div>
                <div id="summarySection" class="p-4 hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                            <tbody id="exemptionTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                                <tr>
                                    <td id="totalGrossIncomeRow" class="px-6 py-2 text-left">মোট Gross Annual Income (PF সহ)</td>
                                    <td id="totalGrossIncome" class="px-6 py-2 text-right font-medium">0</td>
                                </tr>
                                <tr>
                                    <td id="standardDeductionRow" class="px-6 py-2 text-left">বাদ: Standard Deduction (1/3 of Gross or ৳ 5,00,000)</td>
                                    <td id="totalStandardDeduction" class="px-6 py-2 text-right text-green-700 font-medium">0</td>
                                </tr>
                                <tr>
                                    <td id="personalExemptionRow" class="px-6 py-2 text-left">বাদ: Tax Exemption Limit (ব্যক্তিগত করমুক্ত সীমা / Personal Exemption)</td>
                                    <td id="totalExemptionLimit" class="px-6 py-2 text-right text-green-700 font-medium">0</td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-teal-50 border-t-2 border-teal-200 font-semibold">
                                <tr>
                                    <td id="incomeForSlabsTotalRow" class="px-6 py-3 text-left">স্ল্যাব-এর জন্য প্রকৃত করযোগ্য আয় (Actual Income Subject to Slabs)</td>
                                    <td id="incomeForSlabsTotal" class="px-6 py-3 text-right text-red-600">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- F. Tax Calculation Table (Collapsible) -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <div id="taxSlabHeader" class="accordion-button bg-gray-100 hover:bg-gray-200 p-4 rounded-t-lg flex justify-between items-center" onclick="toggleSection('taxSlabSection')">
                    <h2 class="text-lg font-semibold text-gray-800">৫. গ্রস আয়কর গণনা (Gross Tax Calculation by Slab)</h2>
                    <span id="taxSlabIcon" class="text-xl transform transition-transform duration-300">+</span>
                </div>
                <div id="taxSlabSection" class="p-4 hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th id="slabDescriptionCol" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">স্ল্যাব বিবরণ (Slab Description)</th>
                                    <th id="rateCol" class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase">আয়ের হার (Rate)</th>
                                    <th id="taxableIncomeCol" class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase">করযোগ্য আয় (Taxable Tk.)</th>
                                    <th id="taxAmountCol" class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase">করের পরিমাণ (Tax Tk.)</th>
                                </tr>
                            </thead>
                            <tbody id="taxSlabTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <p id="footerNote" class="text-xs text-gray-500 mt-4 border-t pt-2 text-center">
                Calculator developed by Musfikur Rahman - Perry Ellis Bangladesh | Copyright © 2025.
            </p>

        </main>
    </div>

    <script>
        const formatter = new Intl.NumberFormat('bn-BD', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });
        
        let currentLang = 'BN'; // Default language

        const LANG_DATA = {
            'BN': {
                APP_TITLE: 'ডাইনামিক আয়কর ক্যালকুলেটর',
                APP_SUBTITLE_EN: '(Dynamic Income Tax Calculator)',
                APP_INFO: 'Standard Deduction পদ্ধতি',
                SETTINGS_TITLE: 'সেটিংস ও কনফিগারেশন (Settings & Configuration)',
                SETTINGS_WARNING: '**সতর্কতা (Warning):** এই মানগুলি পরিবর্তন করে **Save** করলে, এই ব্রাউজারে অ্যাপটি খোলার সময় সবসময় নতুন মানগুলিই লোড হবে।',
                SETTINGS_EXEMPTION_TITLE: 'করমুক্ত সীমা (Tax Exemption Limits)',
                SETTINGS_MIN_TAX_TITLE: 'ন্যূনতম কর (Minimum Tax Values)',
                SETTINGS_SD_CAP_TITLE: 'সর্বজনীন ছাড়ের সীমা (Standard Deduction Cap)',
                SETTINGS_SLAB_TITLE: 'আয়কর স্ল্যাব হার ও সীমা (Tax Slab Settings)',
                SETTINGS_SAVE_BTN: 'সেভ ও বন্ধ করুন (Save & Close)',
                INPUT_SECTION_TITLE: '১. ইনপুট ভেরিয়েবল (Input Variables)',
                LABEL_EXEMPTION: 'করমুক্ত সীমা (Taxpayer Exemption)',
                LABEL_LOCATION: 'অবস্থান (Minimum Tax Location)',
                LABEL_SALARY: 'মাসিক গ্রস বেতন (Monthly Gross Salary - Tk.)',
                NOTE_SALARY: 'এখানে বেসিক ও সকল মাসিক ভাতা অন্তর্ভুক্ত (Basic + All Allowances).',
                LABEL_PF_RATE: 'PF কন্ট্রিবিউশন রেট (%) (PF Contribution Rate)',
                LABEL_BONUS_CHECK: '১৩ তম মাস / উৎসব বোনাস যুক্ত করুন (Include 13th Month/Festival Bonus)',
                LABEL_OTHER_BONUS: 'অন্যান্য বোনাস (মোট বার্ষিক Tk.) (Other Annual Bonus)',
                LABEL_EMPLOYEE_PF: 'কর্মচারীর (আপনার) বার্ষিক PF অবদান (Employee\'s Annual PF Contribution - Tk.)',
                NOTE_EMPLOYEE_PF: 'এই পরিমাণটি এমপ্লয়ারের কন্ট্রিবিউশনের সমান এবং স্বয়ংক্রিয়ভাবে গণনা করা হয় (Equal to Employer\'s Contribution, Auto-calculated).',
                LABEL_INVESTMENT: 'অন্যান্য বার্ষিক বিনিয়োগ (DPS, শেয়ার, ইত্যাদি Tk.) (Other Annual Investment)',
                
                // Final Summary
                FINAL_TAX_TITLE: '৬. চূড়ান্ত প্রদেয় আয়কর (Net Tax Payable)',
                FINAL_TAX_PAYABLE_LABEL: 'মোট বার্ষিক প্রদেয় আয়কর (Total Annual Tax Payable)',
                MONTHLY_TAX_DEDUCTION_LABEL: 'মাসিক আনুমানিক কর কর্তন (Estimated Monthly Deduction)',
                
                // Section 2 - Summary
                SUMMARY_HEADER: '২. চূড়ান্ত করযোগ্য আয় (Final Taxable Income - After Standard Deduction)',
                SUM_GROSS_INCOME: 'মোট Gross Annual Income (PF সহ)',
                SUM_SD: 'বাদ: Standard Deduction (1/3 of Gross or ৳ 5,00,000)',
                SUM_EXEMPTION: 'বাদ: Tax Exemption Limit (ব্যক্তিগত করমুক্ত সীমা / Personal Exemption)',
                SUM_TAXABLE_TOTAL: 'স্ল্যাব-এর জন্য প্রকৃত করযোগ্য আয় (Actual Income Subject to Slabs)',
                
                // Section 3 - Investment
                INVESTMENT_HEADER: '৩.১ বিনিয়োগের সারসংক্ষেপ (Investment Summary - Incl. PF)',
                INV_EMPLOYEE_PF: 'কর্মচারীর (আপনার) বার্ষিক PF অবদান (Employee\'s Annual PF Contribution)',
                INV_EMPLOYER_PF: 'এমপ্লয়ারের বার্ষিক PF অবদান (Employer\'s Annual PF Contribution)',
                INV_TOTAL_AUTO: 'মোট স্বয়ংক্রিয় PF বিনিয়োগ (Total Automatic PF Investment - Employee\'s Share Only)',
                INV_EXTRA_NEEDED: 'সর্বোচ্চ অতিরিক্ত বিনিয়োগের প্রয়োজন (Max Top-up Investment Needed)',
                
                // Section 4 - Rebate
                REBATE_HEADER: '৪. কর রেয়াত গণনা (Tax Rebate Calculation)',
                REBATE_ELIGIBLE_LIMIT: 'সর্বোচ্চ যোগ্য বিনিয়োগ সীমা (Max Eligible Investment Limit - 20% of Taxable Income)',
                REBATE_ACTUAL_INV: 'মোট প্রকৃত বিনিয়োগ (Total Actual Investment - PF + Other)',
                REBATE_GROSS_TAX: 'গ্রস ট্যাক্স লায়াবিলিটি (Gross Tax Liability - Before Rebate)',
                REBATE_FINAL_REBATE: 'চূড়ান্ত কর রেয়াত (Final Tax Rebate - 15%)',
                REBATE_MIN_TAX: 'ন্যূনতম প্রদেয় কর (Minimum Tax)',
                REBATE_NET_TAX_PAYABLE: 'Net Tax Payable (Gross Tax - Rebate)',
                
                // Section 5 - Slabs
                SLAB_HEADER: '৫. গ্রস আয়কর গণনা (Gross Tax Calculation by Slab)',
                COL_SLAB_DESC: 'স্ল্যাব বিবরণ (Slab Description)',
                COL_RATE: 'আয়ের হার (Rate)',
                COL_TAXABLE_TK: 'করযোগ্য আয় (Taxable Tk.)',
                COL_TAX_TK: 'করের পরিমাণ (Tax Tk.)',
                
                // Footer
                FOOTER_NOTE: 'Calculator developed by Musfikur Rahman - Perry Ellis Bangladesh | Copyright © 2025.',
            },
            'EN': {
                APP_TITLE: 'Dynamic Income Tax Calculator',
                APP_SUBTITLE_EN: '',
                APP_INFO: 'Standard Deduction Method',
                SETTINGS_TITLE: 'Settings & Configuration',
                SETTINGS_WARNING: '**Warning:** If you change these values and **Save**, the new values will be loaded every time the app is opened in this browser.',
                SETTINGS_EXEMPTION_TITLE: 'Tax Exemption Limits',
                SETTINGS_MIN_TAX_TITLE: 'Minimum Tax Values',
                SETTINGS_SD_CAP_TITLE: 'Standard Deduction Cap',
                SETTINGS_SLAB_TITLE: 'Tax Slab Settings',
                SETTINGS_SAVE_BTN: 'Save & Close',
                INPUT_SECTION_TITLE: '1. Input Variables',
                LABEL_EXEMPTION: 'Taxpayer Exemption Limit',
                LABEL_LOCATION: 'Location (Minimum Tax)',
                LABEL_SALARY: 'Monthly Gross Salary (Tk.)',
                NOTE_SALARY: 'Includes Basic + All Allowances.',
                LABEL_PF_RATE: 'PF Contribution Rate (%)',
                LABEL_BONUS_CHECK: 'Include 13th Month/Festival Bonus',
                LABEL_OTHER_BONUS: 'Other Annual Bonus (Total Tk.)',
                LABEL_EMPLOYEE_PF: 'Employee\'s Annual PF Contribution (Tk.)',
                NOTE_EMPLOYEE_PF: 'This amount equals the Employer\'s Contribution and is auto-calculated.',
                LABEL_INVESTMENT: 'Other Annual Investment (DPS, Shares, etc. Tk.)',

                // Final Summary
                FINAL_TAX_TITLE: '6. Net Tax Payable',
                FINAL_TAX_PAYABLE_LABEL: 'Total Annual Tax Payable',
                MONTHLY_TAX_DEDUCTION_LABEL: 'Estimated Monthly Deduction',

                // Section 2 - Summary
                SUMMARY_HEADER: '2. Final Taxable Income (After Standard Deduction)',
                SUM_GROSS_INCOME: 'Total Gross Annual Income (Incl. PF)',
                SUM_SD: 'Less: Standard Deduction (1/3 of Gross or Tk. 5,00,000)',
                SUM_EXEMPTION: 'Less: Tax Exemption Limit (Personal Exemption)',
                SUM_TAXABLE_TOTAL: 'Actual Income Subject to Slabs',

                // Section 3 - Investment
                INVESTMENT_HEADER: '3.1 Investment Summary (Incl. PF)',
                INV_EMPLOYEE_PF: 'Employee\'s Annual PF Contribution',
                INV_EMPLOYER_PF: 'Employer\'s Annual PF Contribution',
                INV_TOTAL_AUTO: 'Total Automatic PF Investment (Employee\'s Share Only)',
                INV_EXTRA_NEEDED: 'Max Top-up Investment Needed',

                // Section 4 - Rebate
                REBATE_HEADER: '4. Tax Rebate Calculation',
                REBATE_ELIGIBLE_LIMIT: 'Max Eligible Investment Limit (20% of Taxable Income)',
                REBATE_ACTUAL_INV: 'Total Actual Investment (PF + Other)',
                REBATE_GROSS_TAX: 'Gross Tax Liability (Before Rebate)',
                REBATE_FINAL_REBATE: 'Final Tax Rebate (15%)',
                REBATE_MIN_TAX: 'Minimum Tax',
                REBATE_NET_TAX_PAYABLE: 'Net Tax Payable (Gross Tax - Rebate)',
                
                // Section 5 - Slabs
                SLAB_HEADER: '5. Gross Tax Calculation by Slab',
                COL_SLAB_DESC: 'Slab Description',
                COL_RATE: 'Rate',
                COL_TAXABLE_TK: 'Taxable Tk.',
                COL_TAX_TK: 'Tax Tk.',
                
                // Footer
                FOOTER_NOTE: 'Calculator developed by Musfikur Rahman - Perry Ellis Bangladesh | Copyright © 2025.',
            }
        };

        // --- Core Translation Logic ---

        function getTranslation(key) {
            return LANG_DATA[currentLang][key] || LANG_DATA['BN'][key];
        }

        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('calculatorLang', lang);
            updateUI();
            calculateTax(); // Recalculate to ensure slab labels are correct
        }

        function updateUI() {
            // General Titles
            document.getElementById('pageTitle').textContent = getTranslation('APP_TITLE') + (currentLang === 'BN' ? ' (Dynamic Income Tax Calculator)' : '');
            document.getElementById('appTitle').textContent = getTranslation('APP_TITLE');
            document.getElementById('appSubTitleEn').textContent = currentLang === 'BN' ? '(Dynamic Income Tax Calculator)' : '';
            document.getElementById('appInfo').textContent = getTranslation('APP_INFO');
            document.getElementById('inputSectionTitle').textContent = getTranslation('INPUT_SECTION_TITLE');

            // Input Labels
            document.getElementById('taxExemptionLabel').textContent = getTranslation('LABEL_EXEMPTION');
            document.getElementById('locationLabel').textContent = getTranslation('LABEL_LOCATION');
            document.getElementById('salaryLabel').textContent = getTranslation('LABEL_SALARY');
            document.getElementById('salaryNote').textContent = getTranslation('NOTE_SALARY');
            document.getElementById('pfRateLabel').textContent = getTranslation('LABEL_PF_RATE');
            document.getElementById('bonusCheckLabel').textContent = getTranslation('LABEL_BONUS_CHECK');
            document.getElementById('otherBonusLabel').textContent = getTranslation('LABEL_OTHER_BONUS');
            document.getElementById('employeePFLabel').textContent = getTranslation('LABEL_EMPLOYEE_PF');
            document.getElementById('employeePFNote').textContent = getTranslation('NOTE_EMPLOYEE_PF');
            document.getElementById('investmentLabel').textContent = getTranslation('LABEL_INVESTMENT');
            
            // Final Summary
            document.getElementById('finalTaxTitle').textContent = getTranslation('FINAL_TAX_TITLE');
            document.getElementById('finalTaxPayableLabel').textContent = getTranslation('FINAL_TAX_PAYABLE_LABEL');
            document.getElementById('monthlyTaxDeductionLabel').textContent = getTranslation('MONTHLY_TAX_DEDUCTION_LABEL');

            // Accordion Headers
            document.getElementById('summaryHeader').querySelector('h2').textContent = getTranslation('SUMMARY_HEADER');
            document.getElementById('investmentSummaryHeader').querySelector('h2').textContent = getTranslation('INVESTMENT_HEADER');
            document.getElementById('rebateHeader').querySelector('h2').textContent = getTranslation('REBATE_HEADER');
            document.getElementById('taxSlabHeader').querySelector('h2').textContent = getTranslation('SLAB_HEADER');
            
            // Table Labels (Summary, Investment, Rebate)
            document.getElementById('totalGrossIncomeRow').textContent = getTranslation('SUM_GROSS_INCOME');
            document.getElementById('standardDeductionRow').textContent = getTranslation('SUM_SD');
            document.getElementById('personalExemptionRow').textContent = getTranslation('SUM_EXEMPTION');
            document.getElementById('incomeForSlabsTotalRow').textContent = getTranslation('SUM_TAXABLE_TOTAL');

            document.getElementById('employeePFContributionRow').textContent = getTranslation('INV_EMPLOYEE_PF');
            document.getElementById('employerPFContributionRow').textContent = getTranslation('INV_EMPLOYER_PF');
            document.getElementById('totalAutoInvestmentRow').textContent = getTranslation('INV_TOTAL_AUTO');
            document.getElementById('extraInvestmentNeededRow').textContent = getTranslation('INV_EXTRA_NEEDED');

            document.getElementById('eligibleInvestmentLimitRow').textContent = getTranslation('REBATE_ELIGIBLE_LIMIT');
            document.getElementById('totalActualInvestmentRow').textContent = getTranslation('REBATE_ACTUAL_INV');
            document.getElementById('grossTaxLiabilityRow').textContent = getTranslation('REBATE_GROSS_TAX');
            document.getElementById('taxRebateAmountRow').textContent = getTranslation('REBATE_FINAL_REBATE');
            document.getElementById('minimumTaxRow').textContent = getTranslation('REBATE_MIN_TAX');
            document.getElementById('netTaxPayableRow').textContent = getTranslation('REBATE_NET_TAX_PAYABLE');

            // Slab Table Headers
            document.getElementById('slabDescriptionCol').textContent = getTranslation('COL_SLAB_DESC');
            document.getElementById('rateCol').textContent = getTranslation('COL_RATE');
            document.getElementById('taxableIncomeCol').textContent = getTranslation('COL_TAXABLE_TK');
            document.getElementById('taxAmountCol').textContent = getTranslation('COL_TAX_TK');
            
            // Footer
            document.getElementById('footerNote').textContent = getTranslation('FOOTER_NOTE');

            // Settings Modal Updates
            document.getElementById('settingsModalTitle').textContent = getTranslation('SETTINGS_TITLE');
            document.getElementById('settingsWarning').textContent = getTranslation('SETTINGS_WARNING');
            document.getElementById('settingsExemptionTitle').textContent = getTranslation('SETTINGS_EXEMPTION_TITLE');
            document.getElementById('settingsMinTaxTitle').textContent = getTranslation('SETTINGS_MIN_TAX_TITLE');
            document.getElementById('settingsSDCapTitle').textContent = getTranslation('SETTINGS_SD_CAP_TITLE');
            document.getElementById('sdCapLabel').value = getTranslation('SETTINGS_SD_CAP_TITLE') + ' (Maximum)';
            document.getElementById('settingsSlabTitle').textContent = getTranslation('SETTINGS_SLAB_TITLE');
            document.getElementById('saveSettingsBtn').textContent = getTranslation('SETTINGS_SAVE_BTN');
            
            // Ensure dropdowns are correctly set based on currentLang
            renderDropdowns(); 
            renderSettings(); // Re-render settings modal content in new language
        }

        // --- Default Tax Slabs ---
        const DEFAULT_TAX_SLABS = [
            { limit: 300000, rate: 0.10, label: "পরবর্তী ৳ 3,00,000 (Next Tk. 3,00,000)" },
            { limit: 400000, rate: 0.15, label: "পরবর্তী ৳ 4,00,000 (Next Tk. 4,00,000)" },
            { limit: 500000, rate: 0.20, label: "পরবর্তী ৳ 5,00,000 (Next Tk. 5,00,000)" },
            { limit: 2000000, rate: 0.25, label: "পরবর্তী ৳ 20,00,000 (Next Tk. 20,00,000)" },
            { limit: Infinity, rate: 0.30, label: "অবশিষ্ট মোট আয় (On Balance Income)" }
        ];

        // Retrieve config values from Local Storage or use defaults
        let TAX_SLABS = JSON.parse(localStorage.getItem('taxSlabs')) || DEFAULT_TAX_SLABS;
        let STANDARD_DEDUCTION_CAP = parseFloat(localStorage.getItem('sdCapValue')) || 500000;
        const REBATE_CAP = 1000000; // Tk. 10,00,000 standard rebate cap

        const DEFAULT_EXEMPTION_LIMITS = [
            { name: "সাধারণ করদাতা (General Taxpayer)", value: 375000, bn_label: "সাধারণ করদাতা", en_label: "General Taxpayer" },
            { name: "নারী/৬৫+ সিনিয়র সিটিজেন (Female/Senior Citizen)", value: 425000, bn_label: "নারী/৬৫+ সিনিয়র সিটিজেন", en_label: "Female/Senior Citizen" },
            { name: "প্রতিবন্ধী/তৃতীয় লিঙ্গ (Disabled/Third Gender)", value: 500000, bn_label: "প্রতিবন্ধী/তৃতীয় লিঙ্গ", en_label: "Disabled/Third Gender" },
            { name: "গেজেটেড মুক্তিযোদ্ধা (Gazetted Freedom Fighter)", value: 525000, bn_label: "গেজেটেড মুক্তিযোদ্ধা", en_label: "Gazetted Freedom Fighter" },
        ];

        const DEFAULT_LOCATION_MIN_TAX = [
            { name: "ঢাকা/চট্টগ্রাম সিটি কর্পোরেশন (Dhaka/Chattogram City Corp)", value: 5000, bn_label: "ঢাকা/চট্টগ্রাম সিটি কর্পোরেশন", en_label: "Dhaka/Chattogram City Corp" },
            { name: "অন্যান্য সিটি কর্পোরেশন (Other City Corporations)", value: 4000, bn_label: "অন্যান্য সিটি কর্পোরেশন", en_label: "Other City Corporations" },
            { name: "সিটি কর্পোরেশনের বাইরে (Outside City Corporations)", value: 3000, bn_label: "সিটি কর্পোরেশনের বাইরে", en_label: "Outside City Corporations" },
        ];
        
        let TAX_EXEMPTION_LIMITS = JSON.parse(localStorage.getItem('taxExemptionLimits')) || DEFAULT_EXEMPTION_LIMITS;
        let LOCATION_MIN_TAX = JSON.parse(localStorage.getItem('locationMinTax')) || DEFAULT_LOCATION_MIN_TAX;

        // --- Modal & Rendering Functions ---

        function openModal() {
            renderSettings();
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function renderSettings() {
            const exemptionContainer = document.getElementById('exemptionSettingsContainer');
            const locationContainer = document.getElementById('locationSettingsContainer');
            const taxSlabContainer = document.getElementById('taxSlabSettingsContainer');
            
            // Set current SD Cap value in modal
            document.getElementById('sdCapValue').value = STANDARD_DEDUCTION_CAP;

            // Render Exemption Limits for Editing
            exemptionContainer.innerHTML = TAX_EXEMPTION_LIMITS.map((item, index) => `
                <div class="flex space-x-2">
                    <input type="text" id="exName${index}" value="${item.name}" class="p-2 border rounded w-1/2 text-sm" placeholder="${currentLang === 'BN' ? 'নাম (Name)' : 'Name'}">
                    <input type="number" id="exValue${index}" value="${item.value}" class="p-2 border rounded w-1/2 text-sm" placeholder="${currentLang === 'BN' ? 'মান (Value Tk.)' : 'Value (Tk.)'}">
                </div>
            `).join('');

            // Render Location Minimum Tax for Editing
            locationContainer.innerHTML = LOCATION_MIN_TAX.map((item, index) => `
                <div class="flex space-x-2">
                    <input type="text" id="locName${index}" value="${item.name}" class="p-2 border rounded w-1/2 text-sm" placeholder="${currentLang === 'BN' ? 'নাম (Name)' : 'Name'}">
                    <input type="number" id="locValue${index}" value="${item.value}" class="p-2 border rounded w-1/2 text-sm" placeholder="${currentLang === 'BN' ? 'মান (Value Tk.)' : 'Value (Tk.)'}">
                </div>
            `).join('');

            // Render Tax Slabs for Editing
            taxSlabContainer.innerHTML = `
                 <div class="flex space-x-2 font-bold text-sm text-gray-700 pb-1 border-b">
                    <span class="w-1/3">${getTranslation('COL_SLAB_DESC')}</span>
                    <span class="w-1/3">${getTranslation('COL_TAXABLE_TK').replace('Taxable Tk.', 'Limit Tk.')}</span>
                    <span class="w-1/3">${getTranslation('COL_RATE').replace('Rate', 'Rate %')}</span>
                </div>
                ${TAX_SLABS.map((item, index) => `
                <div class="flex space-x-2">
                    <input type="text" id="slabLabel${index}" value="${item.label}" class="p-2 border rounded w-1/3 text-sm" placeholder="${currentLang === 'BN' ? 'বিবরণ' : 'Description'}" ${item.limit === Infinity ? 'readonly' : ''}>
                    <input type="number" id="slabLimit${index}" value="${item.limit === Infinity ? '0' : item.limit}" class="p-2 border rounded w-1/3 text-sm" placeholder="${currentLang === 'BN' ? 'সীমা' : 'Limit'}" ${item.limit === Infinity ? 'readonly' : ''}>
                    <input type="number" id="slabRate${index}" value="${item.rate * 100}" class="p-2 border rounded w-1/3 text-sm" placeholder="${currentLang === 'BN' ? 'হার' : 'Rate'}">
                </div>
            `).join('')}
            `;
        }

        function saveSettings() {
            const newExemptions = [];
            const newLocations = [];
            const newSlabs = [];
            const newSdCap = parseFloat(document.getElementById('sdCapValue').value);

            // Save Exemption Limits
            TAX_EXEMPTION_LIMITS.forEach((_, index) => {
                const name = document.getElementById(`exName${index}`).value;
                const value = parseFloat(document.getElementById(`exValue${index}`).value);
                
                // Get clean labels for dropdown
                const bn_label = name.replace(/\s\(.+?\)/, ''); // Remove (English)
                const en_label = name.match(/\(([^)]+)\)/) ? name.match(/\(([^)]+)\)/)[1] : bn_label; // Extract English from ()
                
                if (name && !isNaN(value)) {
                    newExemptions.push({ name, value, bn_label: bn_label, en_label: en_label });
                }
            });

            // Save Location Minimum Tax
            LOCATION_MIN_TAX.forEach((_, index) => {
                const name = document.getElementById(`locName${index}`).value;
                const value = parseFloat(document.getElementById(`locValue${index}`).value);

                const bn_label = name.replace(/\s\(.+?\)/, '');
                const en_label = name.match(/\(([^)]+)\)/) ? name.match(/\(([^)]+)\)/)[1] : bn_label;

                if (name && !isNaN(value)) {
                    newLocations.push({ name, value, bn_label: bn_label, en_label: en_label });
                }
            });

            // Save Tax Slabs
            TAX_SLABS.forEach((_, index) => {
                const label = document.getElementById(`slabLabel${index}`).value;
                let limit = parseFloat(document.getElementById(`slabLimit${index}`).value);
                const rate = parseFloat(document.getElementById(`slabRate${index}`).value) / 100;
                
                // Handle Infinity limit (last slab)
                if (_.limit === Infinity) {
                    limit = Infinity;
                } else if (isNaN(limit) || limit < 0) {
                    limit = 0; // Prevent bad input
                }

                if (label && !isNaN(rate)) {
                    newSlabs.push({ limit: limit, rate: rate, label: label });
                }
            });
            
            // Save Standard Deduction Cap
            if (!isNaN(newSdCap)) {
                localStorage.setItem('sdCapValue', newSdCap);
                STANDARD_DEDUCTION_CAP = newSdCap;
            }

            if (newExemptions.length > 0) {
                localStorage.setItem('taxExemptionLimits', JSON.stringify(newExemptions));
                TAX_EXEMPTION_LIMITS = newExemptions;
            }
            
            if (newLocations.length > 0) {
                localStorage.setItem('locationMinTax', JSON.stringify(newLocations));
                LOCATION_MIN_TAX = newLocations;
            }
            
            if (newSlabs.length > 0) {
                localStorage.setItem('taxSlabs', JSON.stringify(newSlabs));
                TAX_SLABS = newSlabs;
            }
            
            renderDropdowns();
            calculateTax();
            closeModal();
        }

        function renderDropdowns() {
            const exemptionSelect = document.getElementById('taxExemptionSelect');
            const locationSelect = document.getElementById('locationSelect');

            // Populate Exemption Dropdown
            exemptionSelect.innerHTML = TAX_EXEMPTION_LIMITS.map(item => {
                const displayLabel = currentLang === 'BN' ? item.bn_label : item.en_label;
                return `<option value="${item.value}">${displayLabel} (৳ ${formatter.format(item.value)})</option>`;
            }).join('');

            // Populate Location Dropdown
            locationSelect.innerHTML = LOCATION_MIN_TAX.map(item => {
                 const displayLabel = currentLang === 'BN' ? item.bn_label : item.en_label;
                return `<option value="${item.value}">${displayLabel} (৳ ${formatter.format(item.value)})</option>`;
            }).join('');
        }

        // --- Core Calculation Functions ---

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                if (icon) icon.textContent = '−'; 
            } else {
                section.classList.add('hidden');
                if (icon) icon.textContent = '+';
            }
        }
        
        function getTaxExemptionValue() {
            const select = document.getElementById('taxExemptionSelect');
            return parseFloat(select.value) || 0;
        }

        function getMinimumTaxValue() {
            const select = document.getElementById('locationSelect');
            return parseFloat(select.value) || 0;
        }

        function calculateTax() {
            const monthlyGrossSalary = parseFloat(document.getElementById('monthlyGrossSalary').value) || 0;
            const is13thMonth = document.getElementById('is13thMonth').checked;
            const otherBonus = parseFloat(document.getElementById('otherBonus').value) || 0;
            
            // --- PF Rate conversion (From Percentage to Decimal) ---
            const employerPFRatePercentage = parseFloat(document.getElementById('pfRate').value) || 0;
            const employerPFRate = employerPFRatePercentage / 100;
            
            const annualSalary = monthlyGrossSalary * 12;

            // --- Employee PF Contribution (Now calculated automatically from Gross Salary) ---
            const employeePFContribution = annualSalary * employerPFRate; 
            
            // Update the read-only input field display (Reflects Employee Contribution)
            document.getElementById('employeePFContribution').value = employeePFContribution.toFixed(2);


            const otherAnnualInvestment = parseFloat(document.getElementById('otherAnnualInvestment').value) || 0;
            
            // Get dynamic values based on selection
            const taxpayerExemption = getTaxExemptionValue(); 
            const minimumTax = getMinimumTaxValue();

            let annualBonus = otherBonus;
            if (is13thMonth) {
                annualBonus += monthlyGrossSalary;
            }
            
            // Employer's PF Contribution (Income Component, based on Gross Salary)
            const employerPF = annualSalary * employerPFRate;

            // 1. Gross Income Calculation
            const totalGrossIncome = annualSalary + annualBonus + employerPF;

            // 2. Standard Deduction
            // Use dynamic STANDARD_DEDUCTION_CAP retrieved from settings
            const oneThirdGross = totalGrossIncome / 3;
            const standardDeduction = Math.min(oneThirdGross, STANDARD_DEDUCTION_CAP);
            
            const totalTaxableSalary = Math.max(0, totalGrossIncome - standardDeduction); // Taxable Income AFTER Standard Deduction

            // 3. Investment Rebate Calculation
            
            // Total Investment considered for tax rebate (PF + Other Investment)
            // *** CORRECTION: Only Employee PF is counted as Automatic Investment ***
            const totalAutomaticInvestment = employeePFContribution; 
            const totalInvestmentForRebate = totalAutomaticInvestment + otherAnnualInvestment;

            // Eligible Investment Limit (EIL) is 20% of Taxable Salary (AFTER SD)
            const eligibleInvestmentLimit = totalTaxableSalary * 0.20; 
            
            // Calculate how much more is needed to reach the 20% limit
            const extraInvestmentNeeded = Math.max(0, eligibleInvestmentLimit - totalAutomaticInvestment);
            
            // Final amount of investment eligible for rebate (Cannot exceed EIL)
            const finalEligibleInvestmentAmount = Math.min(totalInvestmentForRebate, eligibleInvestmentLimit);
            
            // 4. Gross Tax Liability Calculation
            
            let incomeForSlabs = Math.max(0, totalTaxableSalary - taxpayerExemption);
            let grossTaxLiability = 0;
            const taxSlabDetails = [];
            
            // Get current exemption label from selected value
            const currentExemptionItem = TAX_EXEMPTION_LIMITS.find(item => item.value === taxpayerExemption);
            const exemptionLabel = currentExemptionItem ? (currentLang === 'BN' ? currentExemptionItem.bn_label : currentExemptionItem.en_label) : getTranslation('LABEL_EXEMPTION');


            // Add the initial tax-free slab detail (Taxpayer Exemption)
            taxSlabDetails.push({
                label: `${getTranslation('LABEL_EXEMPTION')} (${exemptionLabel} - ৳ ${formatter.format(taxpayerExemption)})`,
                rate: "0%",
                taxable: Math.min(totalTaxableSalary, taxpayerExemption),
                tax: 0,
                color: 'text-green-600'
            });

            let incomeRemaining = incomeForSlabs;
            
            TAX_SLABS.forEach(slab => {
                let taxedInSlab = 0;
                let taxInSlab = 0;

                if (incomeRemaining > 0) {
                    taxedInSlab = Math.min(incomeRemaining, slab.limit);
                    taxInSlab = taxedInSlab * slab.rate;
                    grossTaxLiability += taxInSlab;
                    incomeRemaining -= taxedInSlab;

                    // Dynamically set slab label based on language
                    let slabLabel;
                    if (currentLang === 'EN') {
                        // Extract English part from the label (e.g., "Next Tk. 3,00,000")
                        slabLabel = slab.label.match(/\(([^)]+)\)/) ? slab.label.match(/\(([^)]+)\)/)[1] : slab.label;
                    } else { // BN
                         // Extract Bangla part from the label (e.g., "পরবর্তী ৳ 3,00,000")
                         slabLabel = slab.label.replace(/\s\(.+?\)/, '');
                    }


                    taxSlabDetails.push({
                        label: slabLabel,
                        rate: `${(slab.rate * 100)}%`,
                        taxable: taxedInSlab,
                        tax: taxInSlab,
                        color: ''
                    });
                }
            });

            // 5. Applying Rebate
            
            // Calculated Rebate is 15% of the final eligible investment (capped at 10,00,000)
            const calculatedRebate = finalEligibleInvestmentAmount * 0.15;
            const finalTaxRebate = Math.min(calculatedRebate, REBATE_CAP); 
            
            // Rebate cannot exceed gross tax liability
            const appliedTaxRebate = Math.min(finalTaxRebate, grossTaxLiability); 
            
            const netTaxPayableBeforeMinTax = Math.max(0, grossTaxLiability - appliedTaxRebate);
            
            // 6. Final Tax Payable (Applying Minimum Tax)
            
            // Tax will be Minimum Tax only if Gross Tax After Rebate is positive.
            // If Net Tax Payable (before min tax) is 0 or negative, final tax is 0.
            // If Net Tax Payable is > 0, compare it with Minimum Tax.

            let finalTaxPayable = 0;
            if (netTaxPayableBeforeMinTax > 0) {
                finalTaxPayable = Math.max(netTaxPayableBeforeMinTax, minimumTax);
            } else {
                 finalTaxPayable = 0;
            }


            // --- Update UI ---

            // Update Investment Summary (Section 3.1)
            document.getElementById('employeePFDisplay').textContent = formatter.format(employeePFContribution);
            document.getElementById('employerPFDisplay').textContent = formatter.format(employerPF);
            document.getElementById('totalAutoInvestmentDisplay').textContent = formatter.format(totalAutomaticInvestment);
            document.getElementById('extraInvestmentNeeded').textContent = formatter.format(Math.max(0, extraInvestmentNeeded));
            
            // Update Rebate Details (Section 4)
            document.getElementById('eligibleInvestmentLimitDisplay').textContent = formatter.format(eligibleInvestmentLimit);
            document.getElementById('totalActualInvestmentDisplay').textContent = formatter.format(totalInvestmentForRebate);
            document.getElementById('grossTaxLiability').textContent = formatter.format(grossTaxLiability);
            document.getElementById('taxRebateAmount').textContent = formatter.format(appliedTaxRebate);
            document.getElementById('minimumTaxValue').textContent = formatter.format(minimumTax);
            document.getElementById('netTaxPayable').textContent = formatter.format(netTaxPayableBeforeMinTax);

            // Update Summary Table (Section 2)
            document.getElementById('totalGrossIncome').textContent = formatter.format(totalGrossIncome);
            document.getElementById('totalStandardDeduction').textContent = formatter.format(standardDeduction);
            document.getElementById('totalExemptionLimit').textContent = formatter.format(taxpayerExemption);
            document.getElementById('incomeForSlabsTotal').textContent = formatter.format(Math.max(0, totalTaxableSalary - taxpayerExemption));

            // Update Tax Slab Table (Section 5)
            const taxSlabBody = document.getElementById('taxSlabTableBody');
            taxSlabBody.innerHTML = taxSlabDetails.map(item => `
                <tr class="${item.taxable === 0 ? 'text-gray-400' : 'text-gray-800'}">
                    <td class="px-6 py-2 text-left font-medium ${item.color}">${item.label}</td>
                    <td class="px-6 py-2 text-right">${item.rate}</td>
                    <td class="px-6 py-2 text-right">${formatter.format(item.taxable)}</td>
                    <td class="px-6 py-2 text-right">${formatter.format(item.tax)}</td>
                </tr>
            `).join('');

            // Final Results (Section 6)
            document.getElementById('finalTaxPayable').textContent = formatter.format(Math.max(0, finalTaxPayable));
            document.getElementById('monthlyTaxDeduction').textContent = formatter.format(Math.max(0, finalTaxPayable) / 12);
        }

        window.onload = () => {
             // Load language from local storage, default to BN
             const savedLang = localStorage.getItem('calculatorLang') || 'BN';
             document.getElementById('languageSelect').value = savedLang;
             currentLang = savedLang;

             renderDropdowns();
             updateUI(); // Initial UI update
             calculateTax();
        };
    </script>
</body>
</html>
